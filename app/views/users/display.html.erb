<%= render "shared/menu" %>

<div id="showUser" class="col-md-12" ng-app ng-controller="displayCtrl">
  <div class="main">	 
	<% if !@profile.nil? && !@profile.new_record? %>
	<%= render "shared/nav" %>
	<div class="clearfix"></div>
	<div class="row">
		<div class='col-md-3'>
			<a id='profileDoc' class='btn btn-default'>Export Profile{{user.admin ? 's' : ''}} </a>
		</div>

		<div class='col-md-3'>
			<a id='visitor_surveys' class='btn btn-default'>Export{{user.admin ? ' All' : ''}} Surveys</a>
		</div>
		
		<div class='col-md-3'>
			<a id='visitor_counts' class='btn btn-default'>Export {{user.admin ? ' All' : ''}}  Visitor Counts</a>
		</div>

		<div class='col-md-3'>
			<a id='sales_slips' class='btn btn-default'>Export {{user.admin ? ' All' : ''}}  Sales Slips</a>
		</div>
	</div>
	<div class="clearfix"></div>
	<div class="profile-header">
		<h2 ng-click="slide('#info')" class="title" >Profile Info <span ng-if="profile.FMC_member">FMC Member!</span></h2>
		<div class="profile-group" id="info">
			<h3><span>Summary</span></h3>
			<div class="row">
				<div class="col-md-7">
					<label>Name:</label><span class="val"><%= @profile.name %></span>
				</div>
				<div class="col-md-5">
					<label>Year Founded:</label><span class="val"><%= @profile.year %></span>
				</div>
			</div>
			<div class="clearfix"></div>
			<div class="row">
				<div class="col-md-7">
					<label>Location:</label><span class="val"><%= @profile.address %> <%= @profile.city %>, <%= @profile.state %> <%= @profile.zip %></span>
				</div>
				<div class="col-md-5">
					<label>County:</label><span class="val"><%= @profile.county %></span>
				</div>
			</div>
			<div class="clearfix"></div>
			<h3><span>Indicators for Impact</span></h3>
			<p>Farmers Markets as Leaders in Collaborative Food System Data Collection and Analysis.</p>
			<div class="row">
				<div class="col-md-6">
					<label>Operates year round?:</label><span class="val"><%= @profile.year_round ? "yes" : "no" %></span>
				</div>
				<div class="col-md-6">
					<label>FMC Member?:</label><span class="val"><%= @profile.FMC_member ? "yes" : "no" %></span>
				</div>
			</div>
			<div class="clearfix"></div>
			<div class="row">
				<div class="col-md-12">
					<label>Host Organization name:</label><span class="val"><%= @profile.host_name %> <%= @profile.incorporated != "Other" ? @profile.incorporated : @profile.incorporated_other %></span>
				</div>
			</div>
			<div ng-if="profile.mission_statement">
				<div class="clearfix"></div>
				<div class="row">
					<div class="col-md-3">
						<label ng-if="profile.when_ms">Published in <%= @profile.when_ms %></label>
					</div>
					<div class="col-md-9 val">
						<span ng-if="!profile.ms_none"><%= @profile.name %>'s mission statement can be found on
							<span ng-if="profile.ms_website">the market's webiste, </span>
							<span ng-if="profile.ms_manual">in the market's manual,  </span>
							<span ng-if="profile.ms_market_promos">in the market's promos, </span>
							<span ng-if="profile.ms_other">{{profile.ms_other_text}} </span>
						</span>
					</div>
				</div>		
			</div>
		</div>
	</div>
	<div class="profile-header" ng-if="mars.length > 0">
		<h2 ng-click="slide('#markets')" class="title" >Markets</h2>
		<div class="profile-group" id="markets">
			<div ng-repeat="market in markets">
				<div ng-if="market != [null,null,null]">
					<h3 ng-if="$index == 0"><span>Main Market</span></h3>
					<h3 ng-if="$index != 0"><span>Alternate Location #{{$index}}</span></h3>
					<div class="row">
						<div class="col-xs-4" ng-if="market[0] != null">
							<h5>Primary Seasonal Market</h5>
							<div class="date">Opening Date: {{market[0].start}}</div>
							<div class="date">Opening Date: {{market[0].end}}</div>
						</div>
						<div class="col-xs-4" ng-if="market[1] != null">
							<h5>Seperate Seasonal #1</h5>
							<div class="date">Opening Date: {{market[1].start}}</div>
							<div class="date">Opening Date: {{market[1].end}}</div>
						</div>
						<div class="col-xs-4" ng-if="market[2] != null">
							<h5>Seperate Seasonal #2</h5>
							<div class="date">Opening Date: {{market[2].start}}</div>
							<div class="date">Opening Date: {{market[2].end}}</div>
						</div>
					</div>
				</div>
				<div class="clearfix"></div>	
			</div>	
		</div>
	</div>
	<% end %>
  </div>

</div>
<%= render "shared/footer" %>
<script type="text/javascript">


var profile = <%= raw(@profile.to_json) %>;
var markets = <%= raw(@markets.to_json) %>;
var management = <%= raw(@management.to_json) %>;
var accessibility = <%= raw(@accessibility.to_json) %>;
var communities = <%= raw(@communities.to_json) %>;
var surveys = <%= raw(@surveys.to_json) %>;

var profiles = <%= raw(@profiles.to_json) %>;
var visitor_surveys = <%= raw(@visitor_surveys.to_json) %>;
var sales_slips = <%= raw(@sales_slips.to_json) %>;
var visitor_counts = <%= raw(@visitor_counts.to_json) %>;

console.log(visitor_surveys);

var visitor_survey_sheet = '';
var visitor_count_sheet = '';
var sales_slip_sheet = '';
var finalVal = '';

for (var key in profile) {if (profile.hasOwnProperty(key)) {key = '"' + key + '",';finalVal += key;}}
for (var key in markets) {if (markets.hasOwnProperty(key) && key != 'profile_id') {key = '"' + key + '",';finalVal += key;}}
for (var key in management) {if (management.hasOwnProperty(key) && key != 'profile_id') {key = '"' + key + '",';finalVal += key;}}
for (var key in accessibility) {if (accessibility.hasOwnProperty(key) && key != 'profile_id') {key = '"' + key + '",';finalVal += key;}}
for (var key in communities) {if (communities.hasOwnProperty(key) && key != 'profile_id') {key = '"' + key + '",';finalVal += key;}}

finalVal += '\n';
var k;

for (var i in profiles){
	var Tprofile = profiles[i].profile;
	var Tmarkets = profiles[i].markets;
	var Tmanagement = profiles[i].management;
	var Taccessibility = profiles[i].accessibility;
	var Tcommunities = profiles[i].community;

	for (var key in Tprofile) {k = '';if (Tprofile.hasOwnProperty(key)) {k = '"' + Tprofile[key] + '",';finalVal += k;}}
	for (var key in Tmarkets) {k = '';if (Tmarkets.hasOwnProperty(key) && key != 'profile_id') {k = '"' + Tmarkets[key] + '",';finalVal += k;}}
	for (var key in Tmanagement) {k = '';if (Tmanagement.hasOwnProperty(key) && key != 'profile_id') {k = '"' + Tmanagement[key] + '",';finalVal += k;}}
	for (var key in Taccessibility) {k = '';if (Taccessibility.hasOwnProperty(key) && key != 'profile_id') {k = '"' + Taccessibility[key] + '",';finalVal += k;}}
	for (var key in Tcommunities) {k = '';if (Tcommunities.hasOwnProperty(key) && key != 'profile_id') {k = '"' + Tcommunities[key] + '",';finalVal += k;}}
	finalVal += '\n';
}

var pom = document.getElementById('profileDoc');
pom.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(finalVal));
pom.setAttribute('download', 'profile.csv');
//pom.click();

var visitor_survey = '"Date",';
var visitor_survey_heading = {
	name: "Market Name",
	yes7: "Dwtn Activities Yes",
	no7: "Dwtn Activities No",
	downtown_spent_morning: "Dwtn Spending Total",////?!!!!!!!!!!!
	downtown_spent_afternoon: "Dwtn Spending Avg",
	spent_morning: "Mkt Spending Morning",
	spent_afternoon: "Mkt Spending Afternoon",
	yes13: "First Visit Yes",
	no13: "First Visit No",
	every_week: "Every Week",
	every_other_week: "Every Other Week",
	every_month: "Every Month",
	less_than_month: "Less Than Month",
	bikes: "Bike",
	bus: "Bus",
	walking: "Walking",
	taxi: "Taxi",
	other_method: "Other Method",
	home_zip: "Zip Codes"//probs delete

};

var foot_list_heading = {
	Watermelons: "Watermelons",
    Wineberries: "Wineberries",
    PawPaws: "PawPaws",                  
    Peaches: "Peaches",                  
    Pears: "Pears",                    
    Plums: "Plums",                    
    Quince: "Quince",                   
    Raspberries: "Raspberries",
    Strawberries: "Strawberries",             
    Tangerines: "Tangerines",               
    Tayberries: "Tayberries",               
    Kumquats: "Kumquats",                 
    Lemons: "Lemons",                   
    Limes: "Limes",                    
    Mulberries: "Mulberries",               
    Oranges: "Oranges",                  
    Fejioas: "Fejioas",                  
    Figs: "Figs",                     
    Gooseberries: "Gooseberries",             
    Grapefruit: "Grapefruit",               
    Grapes: "Grapes",                   
    Honeydew_melons: "Honeydew Melons",          
    Apricots: "Apricots",                 
    Apriums: "Apriums",                  
    Asian_pears: "Asian Pears",
    Avocados: "Avocados",                 
    Blackberries: "Blackberries",             
    Blueberries: "Blueberries",
    Boysenberries: "Boysenberries",            
    Canary_melons: "Canary Melons",            
    Cantaloupes: "Cantaloupes",
    Cherimoyas: "Cherimoyas",               
    Cherries: "Cherries",                 
    Chestnuts: "Chestnuts",                
    Currants: "Currants",                 
    Dates: "Dates",                    
    Artichokes: "Artichokes",               
    Arugula: "Arugula",                  
    Asparagus: "Asparagus",                
    Beets: "Beets",                    
    Beet_greens: "Beet Greens",
    Bok_choy: "Bok Choy",                 
    Broccoli: "Broccoli",                 
    Broccoli_rabe: "Broccoli Rabe",            
    Brussels_sprouts: "Brussels Sprouts",         
    Cabbage: "Cabbage",                  
    Cardoons: "Cardoons",                 
    Carrots: "Carrots",                  
    Cauliflower: "Cauliflower",
    Celeriac: "Celeriac",                 
    Celery: "Celery",                   
    Chard: "Chard",                    
    Chicory: "Chicory",                  
    Chipilín: "Chipilín",                 
    Collards: "Collards",                 
    Cress: "Cress",                    
    Cucumbers: "Cucumbers",                
    Dandelion_greens: "Dandelion Greens",         
    Dry_beans: "Dry_beans",                
    Eggplant: "Eggplant",                 
    Fennel: "Fennel",                   
    Garlic_bulb: "Garlic Bulb",
    Garlic_scapes: "Garlic Scapes",            
    Green_beans: "Green Beans",
    Herbs_fresh: "Herbs Fresh",
    Hierbamora: "Hierbamora",               
    Horseradish: "Horseradish",
    Jicama: "Jicama",                   
    Kale: "Kale",                     
    Kohlrabi: "Kohlrabi",                 
    Lambs_quarters: "Lambs Quarters",           
    Leeks: "Leeks",                    
    Lettuce: "Lettuce",                  
    Lima_Beans: "Lima Beans",               
    Mushrooms: "Mushrooms",                
    Mustard_greens: "Mustard Greens",           
    Okra: "Okra",                     
    Onions: "Onions",                   
    Parsnips: "Parsnips",                 
    Peas: "Peas",                     
    Pea_shoots: "Pea Shoots",               
    Peppers_hot: "Peppers (hot)",
    Peppers_sweet: "Peppers (sweet)",            
    Pumpkins: "Pumpkins",                 
    Potatoes: "Potatoes",                 
    Purslane: "Purslane",                 
    Squash_summer: "Squash (summer)",            
    Squash_winter: "Squash (winter)",            
    Radishes: "Radishes",                 
    Rhubarb: "Rhubarb",                  
    Rutabagas: "Rutabagas",                
    Salsify: "Salsify",                  
    Scallions: "Scallions",                
    Shallots: "Shallots",                 
    Spinach: "Spinach",                  
    Sprouts: "Sprouts",                  
    Sunchokes: "Sunchokes",                
    Sweet_corn: "Sweet Corn",               
    Sweet_potatoes: "Sweet Potatoes",           
    Sweet_potato: "Sweet Potato",             
    Tomatillos: "Tomatillos",               
    Tomatoes: "Tomatoes",                 
    Turnips: "Turnips",                  
    Turnip_greens: "Turnip Greens",            
    Yacon: "Yacon",                    
    Fava_beans: "Fava Beans",               
    Jujubes: "Jujubes",                  
    Apples: "Apples"
};

if(visitor_surveys[0] && visitor_surveys[0][0]){
	for (var key in visitor_surveys[0][0]) {
		if(key != 'profile_id' && key != 'id' && key != 'date'){
			if(key in foot_list_heading) {
				key = '"' + foot_list_heading[key] + '",';
				visitor_survey += key;
			}else if(key in visitor_survey_heading) {
				key = '"' + visitor_survey_heading[key] + '",';
				visitor_survey += key;
			}
		}
	}
	visitor_survey += '\n';

	for (var i in visitor_surveys){
		for(var j in visitor_surveys[i]){

			var survey = visitor_surveys[i][j];
			visitor_survey += survey.date + ',';
			for (var key in survey) {
				k = '';
				if ((foot_list_heading.hasOwnProperty(key) || visitor_survey_heading.hasOwnProperty(key)) && key != 'profile_id' && key != 'id' && key != 'date') {
						k = '"' + survey[key] + '",';
					visitor_survey += k;
				}
			}
			visitor_survey += '\n';
		}
	}
}

var csv1 = document.getElementById('visitor_surveys');
csv1.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(visitor_survey));
csv1.setAttribute('download', 'VisitorSurveys.csv');

var sales_slip_heading = {
	Debt_sales: "Debit/credit Sales",
	SNAP_sales: "SNAP/EBT Sales",
	SNAP_transactions: "EBT transactions",
	Senior_FMNP_sales: "Senior FMNP Sales",
	WIC_FMNP_sales: "WIC FNMP Sales",
	WIC_sales: "WIC CVV Sales",
	farm_sales: "Farm Product Sales",
	pounds_donated: "Donated Food (lbs)",
	ready_sales: "Ready-to-eat Sales",
	total_sales: "Total Sales",
	value_sales: "Value-added Sales",
	values_donated: "Donated Food ($)",
	//don't forget vegetables, date, name and count

};

var sales_slips_csv = 'Profile, Date, Surveys completed, Total Sales,Farm Product Sales,Value-added sales,Ready-to-eat sales,Debit/credit sales,WIC FMNP sales,WIC CVV sales,Senior FMNP sales,SNAP/EBT sales,EBT transactions (#),Donated food (pounds),Donated food ($), Most common vegetables\n';

for(var i = 0; i < sales_slips.length; i++){
	var prof = sales_slips[i];
	if(!prof.slips && prof.slips.length == 0)
		continue;

	sales_slips_csv += prof.name + '\n';
	for(var j = 0; j < prof.slips.length; j++){
		var day = prof.slips[j];
		if(day.length == 0)
			continue;

		sales_slips_csv += ','+day[0].date+','+day.length;
		for(var k = 0; k < day.length; k++){
			var slip = day[k];
			sales_slips_csv += ','+( k > 0 ? ',,': '')+slip.total_sales+','+slip.farm_sales+','+slip.value_sales+','+slip.ready_sales+','+slip.Debt_sales+','+slip.WIC_FMNP_sales+','+slip.WIC_sales+','+slip.Senior_FMNP_sales+','+slip.SNAP_sales+','+slip.SNAP_transactions+','+slip.pounds_donated+','+slip.values_donated+',"'+slip.veg1+ ','+slip.veg2+','+slip.veg3+'"\n'
		}
	}

}

var csv1 = document.getElementById('sales_slips');
csv1.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(sales_slips_csv));
csv1.setAttribute('download', 'SalesSlips.csv');

var visitor_count_csv = '';

for(var i = 0; i < visitor_counts.length; i++){
	var vci = visitor_counts[i];
	if(vci.name == null)
		continue;
	visitor_count_csv += vci.name + ',\n';
	for(var j = 0; j < vci.points.length; j ++){
		var vcj = vci.points[j];
		if(vcj == undefined)
			break;
		visitor_count_csv += '"",Day: '+vci['day'+j] + ',\n';
		visitor_count_csv += '"","","",Entry Point 1,Entry Point 2,Entry Point 3,Entry Point 4,'+
									'Entry Point 5,Entry Point 6,Entry Point 7,Entry Point 8,\n';
		for(var k = 0; k < vcj.length; k++){
			visitor_count_csv += '"","",'+(k == 0 ? 'Early Visitors' : ('Sample period: '+k))+ ',';
			for(var l = 0; l < vcj[k].length; l++){
				visitor_count_csv += vcj[k][l].count + ',';
			}
			visitor_count_csv += '\n';
		}
	}
	visitor_count_csv += '\n';
}

var csv1 = document.getElementById('visitor_counts');
csv1.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(visitor_count_csv));
csv1.setAttribute('download', 'VisitorCounts.csv');


function displayCtrl($scope){

	$scope.profile = <%= raw(@profile.to_json) %>;
	$scope.mars = <%= raw(@markets.to_json) %>;
	$scope.user = <%= raw(@user.to_json) %>;

	var seasonalArr = [1,1,1];
	var num;

	$scope.markets = [[null,null,null],[null,null,null],[null,null,null]];

	if($scope.mars != null)
		$scope.mars.forEach(function(entry){
			num = entry.market_num - 1;
			if(entry.market_type == "market")
				$scope.markets[num][0] = entry;
			else if(entry.market_type == "seasonal"){
				if($scope.markets[num][1] == null)
					$scope.markets[num][1] = entry;
				else
					$scope.markets[num][2] = entry;
			}
		});

	//console.log($scope.markets);


	$scope.slide = function(id) {
	  	if ($(id).is(":hidden")) {
	    	$(id).slideDown("slow");
	  	}else{
	    	$(id).slideUp("slow");
	  	}
	};

}
</script>
