<%= render "shared/menu" %>

<div id="showUser" class="col-md-12" ng-app ng-controller="displayCtrl">
  <div class="main">	 
	<% if !@profile.nil? && !@profile.new_record? %>
	<%= render "shared/nav" %>
	<div class="clearfix"></div>
	<div row>
		<div class="col-md-3">
			<a id="profileDoc" class="btn btn-default">Export Profile</a>
		</div>
		<div class="col-md-3">
			<a id="visitor_survey" class="btn btn-default">Visitor Surveys</a>
		</div>
	</div>
	<div class="clearfix"></div>
	<div class="profile-header">
		<h2 ng-click="slide('#info')" class="title" >Profile Info <span ng-if="profile.FMC_member">FMC Member!</span></h2>
		<div class="profile-group" id="info">
			<h3><span>Summary</span></h3>
			<div class="row">
				<div class="col-md-7">
					<label>Name:</label><span class="val"><%= @profile.name %></span>
				</div>
				<div class="col-md-5">
					<label>Year Founded:</label><span class="val"><%= @profile.year %></span>
				</div>
			</div>
			<div class="clearfix"></div>
			<div class="row">
				<div class="col-md-7">
					<label>Location:</label><span class="val"><%= @profile.address %> <%= @profile.city %>, <%= @profile.state %> <%= @profile.zip %></span>
				</div>
				<div class="col-md-5">
					<label>County:</label><span class="val"><%= @profile.county %></span>
				</div>
			</div>
			<div class="clearfix"></div>
			<h3><span>Indicators for Impact</span></h3>
			<p>Farmers Markets as Leaders in Collaborative Food System Data Collection and Analysis.</p>
			<div class="row">
				<div class="col-md-6">
					<label>Operates year round?:</label><span class="val"><%= @profile.year_round ? "yes" : "no" %></span>
				</div>
				<div class="col-md-6">
					<label>FMC Member?:</label><span class="val"><%= @profile.FMC_member ? "yes" : "no" %></span>
				</div>
			</div>
			<div class="clearfix"></div>
			<div class="row">
				<div class="col-md-12">
					<label>Host Organization name:</label><span class="val"><%= @profile.host_name %> <%= @profile.incorporated != "Other" ? @profile.incorporated : @profile.incorporated_other %></span>
				</div>
			</div>
			<div ng-if="profile.mission_statement">
				<div class="clearfix"></div>
				<div class="row">
					<div class="col-md-3">
						<label ng-if="profile.when_ms">Published in <%= @profile.when_ms %></label>
					</div>
					<div class="col-md-9 val">
						<span ng-if="!profile.ms_none"><%= @profile.name %>'s mission statement can be found on
							<span ng-if="profile.ms_website">the market's webiste, </span>
							<span ng-if="profile.ms_manual">in the market's manual,  </span>
							<span ng-if="profile.ms_market_promos">in the market's promos, </span>
							<span ng-if="profile.ms_other">{{profile.ms_other_text}} </span>
						</span>
					</div>
				</div>		
			</div>
		</div>
	</div>
	<div class="profile-header" ng-if="mars.length > 0">
		<h2 ng-click="slide('#markets')" class="title" >Markets</h2>
		<div class="profile-group" id="markets">
			<div ng-repeat="market in markets">
				<div ng-if="market != [null,null,null]">
					<h3 ng-if="$index == 0"><span>Main Market</span></h3>
					<h3 ng-if="$index != 0"><span>Alternate Location #{{$index}}</span></h3>
					<div class="row">
						<div class="col-xs-4" ng-if="market[0] != null">
							<h5>Primary Seasonal Market</h5>
							<div class="date">Opening Date: {{market[0].start}}</div>
							<div class="date">Opening Date: {{market[0].end}}</div>
						</div>
						<div class="col-xs-4" ng-if="market[1] != null">
							<h5>Seperate Seasonal #1</h5>
							<div class="date">Opening Date: {{market[1].start}}</div>
							<div class="date">Opening Date: {{market[1].end}}</div>
						</div>
						<div class="col-xs-4" ng-if="market[2] != null">
							<h5>Seperate Seasonal #2</h5>
							<div class="date">Opening Date: {{market[2].start}}</div>
							<div class="date">Opening Date: {{market[2].end}}</div>
						</div>
					</div>
				</div>
				<div class="clearfix"></div>	
			</div>	
		</div>
	</div>
	<% end %>
  </div>

</div>
<script type="text/javascript">
//var host = "http://localhost:3000/"
//var host = "https://fathomless-bayou-8856.herokuapp.com/";
var profile = <%= raw(@profile.to_json) %>;
var markets = <%= raw(@markets.to_json) %>;
var management = <%= raw(@management.to_json) %>;
var accessibility = <%= raw(@accessibility.to_json) %>;
var communities = <%= raw(@communities.to_json) %>;

var surveys = <%= raw(@surveys.to_json) %>;

var finalVal = '';

for (var key in profile) {if (profile.hasOwnProperty(key)) {key = '"' + key + '",';finalVal += key;}}
for (var key in markets) {if (markets.hasOwnProperty(key) && key != 'profile_id') {key = '"' + key + '",';finalVal += key;}}
for (var key in management) {if (management.hasOwnProperty(key) && key != 'profile_id') {key = '"' + key + '",';finalVal += key;}}
for (var key in accessibility) {if (accessibility.hasOwnProperty(key) && key != 'profile_id') {key = '"' + key + '",';finalVal += key;}}
for (var key in communities) {if (communities.hasOwnProperty(key) && key != 'profile_id') {key = '"' + key + '",';finalVal += key;}}

finalVal += '\n';
var k;

for (var key in profile) {k = '';if (profile.hasOwnProperty(key)) {k = '"' + profile[key] + '",';finalVal += k;}}
for (var key in markets) {k = '';if (markets.hasOwnProperty(key) && key != 'profile_id') {k = '"' + markets[key] + '",';finalVal += k;}}
for (var key in management) {k = '';if (management.hasOwnProperty(key) && key != 'profile_id') {k = '"' + management[key] + '",';finalVal += k;}}
for (var key in accessibility) {k = '';if (accessibility.hasOwnProperty(key) && key != 'profile_id') {k = '"' + accessibility[key] + '",';finalVal += k;}}
for (var key in communities) {k = '';if (communities.hasOwnProperty(key) && key != 'profile_id') {k = '"' + communities[key] + '",';finalVal += k;}}



var pom = document.getElementById('profileDoc');
pom.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(finalVal));
pom.setAttribute('download', 'profile.csv');
//pom.click();

var visitor_survey = '';

for (var key in surveys[0]) {if (surveys[0].hasOwnProperty(key) && key != 'profile_id' && key != 'id') {key = '"' + key + '",';visitor_survey += key;}}
visitor_survey += '\n';

for (var s = 0; s < surveys.length; s++){
	var survey = surveys[s];
	for (var key in survey) {
		k = '';
		if (survey.hasOwnProperty(key) && key != 'profile_id' && key != 'id') {
			k = '"' + survey[key] + '",';
			visitor_survey += k;
		}
	}
	visitor_survey += '\n';
}

var csv1 = document.getElementById('visitor_survey');
csv1.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(visitor_survey));
csv1.setAttribute('download', 'VisitorSurveys.csv');

function displayCtrl($scope){
	  //  $('#sidebar ul li')[1].className = "active";

	$scope.profile = <%= raw(@profile.to_json) %>;
	$scope.mars = <%= raw(@markets.to_json) %>;
	console.log($scope.profile);
	console.log($scope.mars);

	var seasonalArr = [1,1,1];
	var num;

	$scope.markets = [[null,null,null],[null,null,null],[null,null,null]];

	if($scope.mars != null)
		$scope.mars.forEach(function(entry){
			num = entry.market_num - 1;
			if(entry.market_type == "market")
				$scope.markets[num][0] = entry;
			else if(entry.market_type == "seasonal"){
				if($scope.markets[num][1] == null)
					$scope.markets[num][1] = entry;
				else
					$scope.markets[num][2] = entry;
			}
		});

	console.log($scope.markets);


	$scope.slide = function(id) {
	  	if ($(id).is(":hidden")) {
	    	$(id).slideDown("slow");
	  	}else{
	    	$(id).slideUp("slow");
	  	}
	};

}
</script>
