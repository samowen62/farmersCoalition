<%= render "shared/menu" %>

<div id="survey" class="col-md-12" ng-app ng-controller="visitorCtrl">
  <div id="summary" class="main">

	<%= render "shared/nav" %>

  	<h1>Visitor Count</h1>
  	<div class="col-md-12">
  		<div class="col-md-3" ng-show="!small">
  			<h2>Sample Day</h2>
  		</div>
		<div class="col-md-9">
			<h2 style="  margin-top: 0px;">Sample Period</h2>
			<div class="period-list row">
				<div class="item" ng-click="changePeriod(0)" ng-class="{'ear-active' : period == 0}">Early</div>
				<div class="item" ng-click="changePeriod(1)" ng-class="{'active' : period == 1}">1</div>
				<div class="item" ng-click="changePeriod(2)" ng-class="{'active' : period == 2}">2</div>
				<div class="item" ng-click="changePeriod(3)" ng-class="{'active' : period == 3}">3</div>
				<div class="item" ng-click="changePeriod(4)" ng-class="{'active' : period == 4}">4</div>
				<div class="item" ng-click="changePeriod(5)" ng-class="{'active' : period == 5}">5</div>
				<div class="item" ng-click="changePeriod(6)" ng-class="{'active' : period == 6}">6</div>
				<div class="item" ng-click="changePeriod(7)" ng-class="{'active' : period == 7}">7</div>
				<div class="item" ng-click="changePeriod(8)" ng-class="{'active' : period == 8}">8</div>
			</div>
		</div>
		<div ng-show="small" class="col-md-9">
				<div class="row">
					<h2>Sample Day</h2>
				</div>
				<div class="row">
					<div class="period-list" style="width: 300px;margin-left: -10px;margin-top: 14px;">
						<div class="item" ng-click="changeDay(0)" ng-class="{'active' : day == 0}">1</div>
						<div class="item" ng-click="changeDay(1)" ng-class="{'active' : day == 1}">2</div>
						<div class="item" ng-click="changeDay(2)" ng-class="{'active' : day == 2}">3</div>
						<div class="item" ng-click="changeDay(3)" ng-class="{'active' : day == 3}">4</div>
					</div>
				</div>
			</div>
		<div class="col-md-12">
			<div ng-show="!small" class="col-md-3">
				<div class="row">
					<div class="btn-list">
						<ul>
							<li ng-click="changeDay(0)" ng-class="{'active' : day == 0}">1</li>
							<li ng-click="changeDay(1)" ng-class="{'active' : day == 1}">2</li>
							<li ng-click="changeDay(2)" ng-class="{'active' : day == 2}">3</li>
							<li ng-click="changeDay(3)" ng-class="{'active' : day == 3}">4</li>
						</ul>
					</div>
				</div>
			</div>
			<div class="col-md-9">
				<div class="row">
					<table style="  margin-top: 20px;">
						<tr data-ng-repeat="i in points[day][period] track by $index">
							<td><label>{{(period == 0 ? 'In the Market #' : 'Entry Point #') + ($index + 1)}}</label></td>
							<!--td><label>Start</label></td>
							<td><input type="text" class="t" ng-model="points[day][period][$index].start"></td>
							<td><label>End</label></td>
							<td><input type="text" class="t" ng-model="points[day][period][$index].end"></td-->
							<td><label>Count</label></td>
							<td><input type="text" style="width: 35px;" ng-model="points[day][period][$index].count" class="hasPtTimeSelect"></td>
						</tr>
						<tr>
							<td colspan="3"><a id="add" href="javascript:void(0)" ng-click="addPoint()">+</a><a href="javascript:void(0)" ng-click="removePoint()" id="rem">-</a></td>
						</tr>
					</table>
				</div>
				<div class="row">
					<a class="btn btn-default" href="javascript:void" ng-click="submitSurvey()">Save Page</a>
				</div>
			</div>
		</div>
	</div>
  </div>
</div>
<div id="successScreen"> 
	<a href="#" class="suc-text">Success!</a>
</div> 
<div id="cover" ></div>

<script type="text/javascript">

$(document).ready(function(){
	//window.setInterval(function(){
  		$('body input').ptTimeSelect();
	//}, 500);
});

function check(){
	//because I guess angular is too slow or something?
	$('body input').ptTimeSelect();
}

function visitorCtrl($scope){
	$scope.points = <%= raw(@points.to_json) %>;
	$scope.small = $(window).width() <= 976;

	$scope.day = 1;
	$scope.period = 1;



	$scope.changeDay = function(i){
		$scope.day = i;
		setTimeout(function(){ $('body input').ptTimeSelect();} ,250);
	}

	$scope.changePeriod= function(i){
		$scope.period = i;
		setTimeout(function(){ $('body input').ptTimeSelect();} ,250);
	}

	$scope.addPoint = function(){
		if($scope.points[$scope.day][$scope.period].length < 10){
			$scope.points[$scope.day][$scope.period].push({});
			setTimeout(function(){ $('body input').ptTimeSelect();} ,250);
		}
	}

	$scope.removePoint = function(){
		if($scope.points[$scope.day][$scope.period].length > 0){
			$scope.points[$scope.day][$scope.period].pop();
			setTimeout(function(){ $('body input').ptTimeSelect();} ,250);
		}
	}

	$scope.submitSurvey = function(){
		/*$.each($('.t'), function(k,e){ 
			$scope.points[$scope.day][$scope.period][parseInt(k/2)][k % 2 == 0 ? 'start' : 'end'] = e.value;
			$scope.points[$scope.day][$scope.period][parseInt(k/2)]['ptNum'] = parseInt(k/2);
		});*/


		console.log($scope.points[$scope.day][$scope.period]);

		$.ajax({
			type: "POST",
			url: "/post_visitor_count",
			data: JSON.stringify({points: $scope.points[$scope.day][$scope.period], day: $scope.day, period: $scope.period}),
			contentType: "application/json",
			success: function(data){
				console.log(data);
				location.href = '#successScreen';
				setTimeout(ret, 1000);
			},
			error: function(data){
				alert("Error Submitting Data");
			}
		});
	};

	function ret(){
		location.href = "#";
	}
}

</script>
