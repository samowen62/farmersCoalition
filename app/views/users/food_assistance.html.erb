<%= render "shared/menu" %>

<div id="survey" class="col-md-12" ng-app ng-controller="surveyCtrl">
  <div id="summary" class="main money">
	<%= render "shared/nav" %>

  	<h1>Food Assistance Sales</h1>
	<div class="col-md-12">
		<table id="food-assistance">
			<thead>
				<tr>
					<th><label>Transaction Date</label></th>
					<th class="fixed"><label>Benefit Type</label></th>
					<th class="fixed"><label>Last 8 Digits on SNAP Card</label></th>
					<th class="fixed"><label>Amount Redeemed</label></th>
					<th class="fixed"><label>Zip Code</label></th>
					<th><label>First time?</label></th>
					<th></th>
				</tr>
			</thead>
			<tbody>
				<tr ng-repeat="f in foods">
					<td><input ng-model="f.transaction_date" class="tcal" /></td>
					<td class="fixed"><select ng-model="f.type_of_assistance" >
						<option value="SNAP" ng-if="accessibility.accept_SNAP">SNAP</option>
						<option value="WIC FMNP" ng-if="accessibility.accept_FMNP">WIC FMNP</option>
						<option value="WIC CVV" ng-if="accessibility.accept_CVV">WIC CVV</option>
						<option value="Senior FMNP" ng-if="accessibility.accept_FMNP_senior">Senior FMNP</option>
					</select></td>
					<td class="fixed"><input ng-model="f.digits_of_snap" /></td>
					<td class="fixed"><input ng-model="f.redeemed" /></td>
					<td class="fixed"><input ng-model="f.zip_code" /></td>
					<td><select ng-model="f.first_name" >
						<option value="0">Y</option>
						<option value="1">N</option>
					</select></td>
					<td><a ng-click="editRow(f, $index)" class="btn btn-default" href="javascript:void(0)">Edit</a></td>
				</tr>
				<tr>
					<td><input ng-model="newFood.transaction_date"  class="tcal" /></td>
					<td class="fixed"><select ng-model="newFood.type_of_assistance" >
						<option value="SNAP" ng-if="accessibility.accept_SNAP">SNAP</option>
						<option value="WIC FMNP" ng-if="accessibility.accept_FMNP">WIC FMNP</option>
						<option value="WIC CVV" ng-if="accessibility.accept_CVV">WIC CVV</option>
						<option value="Senior FMNP" ng-if="accessibility.accept_FMNP_senior">Senior FMNP</option>
					</select></td>
					<td class="fixed"><input ng-model="newFood.digits_of_snap" /></td>
					<td class="fixed"><input ng-model="newFood.redeemed" /></td>
					<td class="fixed"><input ng-model="newFood.zip_code" /></td>
					<td><select ng-model="newFood.first_name" >
						<option value="0">Y</option>
						<option value="1">N</option>
					</select></td>
					<td><a ng-click="addRow()" class="btn btn-success" href="javascript:void(0)">Add</a></td>
				</tr>
			</tbody>
		</table>
	</div>
  </div>
</div>
<div id="successScreen"> 
	<a href="#" class="suc-text">Success!</a>
</div> 
<div id="cover" ></div>

<script type="text/javascript">

function surveyCtrl($scope){
	
	$scope.metrics = <%= raw(@metrics.to_json) %>;
	$scope.foods = <%= raw(@foods.to_json) %>;
	$scope.accessibility = <%= raw(@accessibility.to_json) %>;
	$scope.newFood = {id: -1};

	$scope.editRow = function(row, ind){
		row.transaction_date = $('.tcal')[ind].value;

		$.ajax({
			type: "POST",
			url: "/post_food_assistance",
			data: JSON.stringify(row),
			contentType: "application/json",
			success: function(data){
				console.log(data);
				$scope.foods = data;
				location.href = '#successScreen';
				setTimeout(ret, 1000);
				$scope.newFood = {id: -1};
			},
			error: function(data){
				alert("Error Submitting Data");
			}
		});
	}

	$scope.addRow = function(){
		$scope.newFood.transaction_date = $('.tcal')[$scope.foods.length].value;

		$.ajax({
			type: "POST",
			url: "/post_food_assistance",
			data: JSON.stringify($scope.newFood),
			contentType: "application/json",
			success: function(data){
				console.log(data);
				$scope.foods = data;
				location.href = '#successScreen';
				setTimeout(ret, 1000);
				$scope.newFood = {id: -1};
			},
			error: function(data){
				alert("Error Submitting Data");
			}
		});
	}

	function ret(){
		location.href = "#";
	}
}

</script>
