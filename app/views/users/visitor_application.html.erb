<%= render "shared/menu" %>

<div id="survey" class="col-md-12" ng-app ng-controller="visitorCtrl">
	<div id="summary" class="main money">

		<%= render "shared/nav" %>

		<h1>Visitor Application</h1>
		<div class="col-md-10 col-md-offset-1">
		  	<div class="progress" style="width:96%">
			  <div class="progress-bar progress-bar-success progress-bar-striped active" role="progressbar" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100" style="width: 26%">
			  </div>
			</div>
			<ul class="navig">
				<li>
					<a ng-click="changeTab(1)">1</a>
				</li>
				<li>
					<a ng-click="changeTab(2)">2</a>
				</li>
				<li>
					<a ng-click="changeTab(3)">3</a>
				</li>
				<li>
					<a ng-click="changeTab(4)">4</a>
				</li>
			</ul>
		</div>
		<div class="col-md-12" ng-show="tab == 1">
			<div class="col-md-6" ng-if="metrics[1] || metrics[9]">
				<div style="background-color: #eee;padding: 5px;border-radius: 5px;">
					In {{year}}, what were your business’ TOTAL gross sales at {{profile.name}}, by category?<br />
					<ul>
					  <li>Value-added (or “Processed”) Foods include baked goods, pickles, condiments, jams, charcuterie, etc.</li>
					  <li>Ready-to-Eat (or “Hot”) Foods are freshly made foods available for immediate consumption on-site at market.)</li>
					 </ul>
				</div>
					<div class="row">
						<h2>Total {{year}} gross sales at {{profile.name}}</h2>
					</div>
					<div class="row">
						<label class="col-xs-7">Farm product sales:</label>
						<span class="col-xs-1 dollars">$</span>
						<div  class="col-xs-3"><input type="text" ng-model="survey.farm_sales" placeholder="0.00" /></div>
					</div>
					<div class="row">
						<label class="col-xs-7">Value-added sales:</label>
						<span class="col-xs-1 dollars">$</span>
						<div  class="col-xs-3"><input type="text" ng-model="survey.value_sales" placeholder="0.00" /></div>
					</div>
					<div class="row">
						<label class="col-xs-7">Ready-to-eat food sales:</label>
						<span class="col-xs-1 dollars">$</span>
						<div  class="col-xs-3"><input type="text" ng-model="survey.ready_sales" placeholder="0.00" /></div>
					</div>
					<div class="row">
						<label class="col-xs-7">Other product sales (crafts, services, etc.):</label>
						<span class="col-xs-1 dollars">$</span>
						<div  class="col-xs-3"><input type="text" ng-model="survey.other_sales" placeholder="0.00" /></div>
					</div>
					<div class="row">
						<label>Do you anticipate less, the same, or higher total gross sales at this market in {{year  + 1}}?:</label>
						<div class="col-md-12 radioGroup">
							<label class="radio" ng-click="setRad('level_of_sales','less')" ng-class="{active : survey.level_of_sales == 'less'}">Less</label>
							<label class="radio" ng-click="setRad('level_of_sales','same')" ng-class="{active : survey.level_of_sales == 'same'}">Same</label>
							<label class="radio" ng-click="setRad('level_of_sales','higher')" ng-class="{active : survey.level_of_sales == 'higher'}">Higher</label>
						</div>
					</div>				
				</div>
				<div class="col-md-6" ng-if="metrics[2]">
					<label>Please provide up to two physical addresses for your business’ primary point(s) of production.  No P.O. Boxes, please</label>
					<div class="row">
						<label>Primary production location:</label><div class="clearfix"></div>
						<input style="width: 100%;" ng-model="survey.primary_loc" />
					</div>
					<div class="row">
						<label>Secondary production location:</label><div class="clearfix"></div>
						<input style="width: 100%;" ng-model="survey.secondary_loc" />
					</div>
				</div>
				<div class="col-md-6" ng-if="metrics[3]">
					<label>Please use the table below to report your {{year}} farm acreage information.</label>
					<h2>Total acres:</h2> 
					<div class="row">
		   				<label>Owned:</label>
	   					<input ng-model="survey.acres_owned" style="  float: right;" />
					</div>
					<div class="row">
		   				<label>Leased:</label>
	   					<input ng-model="survey.acres_leased" style="  float: right;"/>
					</div>
					<div class="row">
		   				<label>Cultivated or grazed in {{year}}:</label>
	   					<input ng-model="survey.acres_cultivated" style="  float: right;"/>
					</div>

	<!--Percent of total cultivated or grazed acres devoted to 2014 farmers market production (please estimate to the best of your ability):-->

					<div class="row" ng-if="metrics[8] && ! metrics[2]">
						<label>Do you anticipate fewer, the same, or more acres devoted to production for the {{profile.name}} in {{year + 1}}?:</label>
						<div class="col-md-12 radioGroup">
							<label class="radio" ng-click="setRad('level_of_worker_anticipation','less')" ng-class="{active : survey.level_of_worker_anticipation == 'less'}">Less</label>
							<label class="radio" ng-click="setRad('level_of_worker_anticipation','same')" ng-class="{active : survey.level_of_worker_anticipation == 'same'}">Same</label>
							<label class="radio" ng-click="setRad('level_of_worker_anticipation','higher')" ng-class="{active : survey.level_of_worker_anticipation == 'higher'}">Higher</label>
						</div>
					</div>    


				</div>
				<div class="col-md-6" ng-if="metrics[10]">
					<label>Including yourself, how many people worked for your business either seasonally or year-round in {{year}}? Please include family workers (paid and unpaid), hired production or office workers, people hired to sell at markets, contract or custom hire farm labor, and paid interns or apprentices. If zero, please enter 0.
					<div class="row">
		   				<label>Seasonal (worked 149 days or less):</label>
		   				<input ng-model="survey.workers_seasonal" />
		   			</div>
		   			<div class="row">
		   				<label>Year-round (worked 150 days or more):</label>
		   				<input ng-model="survey.workers_yearly" />
		   			</div>
					<div class="row">
						<label>Do you anticipate fewer, the same, or more workers devoted to production and marketing for this market in {{year + 1}}?</label>    
						<div class="col-md-12 radioGroup">
							<label class="radio" ng-click="setRad('level_of_worker_anticipation','less')" ng-class="{active : survey.level_of_worker_anticipation == 'less'}">Less</label>
							<label class="radio" ng-click="setRad('level_of_worker_anticipation','same')" ng-class="{active : survey.level_of_worker_anticipation == 'same'}">Same</label>
							<label class="radio" ng-click="setRad('level_of_worker_anticipation','higher')" ng-class="{active : survey.level_of_worker_anticipation == 'higher'}">Higher</label>
						</div>
					</div>
				</div>
			</div>
			<div ng-show="tab == 2">
				<div class="col-md-6" ng-if="metrics[11]">
					<div class="col-md-12">
						<label>Please think about all individuals chiefly responsible for day-to-day decisions in your farm business, including yourself.  As of December 31, {{year}}, for how many years have these owner/operators been farming?  (Please respond for all chief owners/operators as applicable.)</label>
						<div class="row">
							<label>Owner 1</label>
							<input ng-model="owner1_years" />
						</div>
						<div class="row">
							<label>Owner 2</label>
							<input ng-model="owner2_years" />
						</div>
					</div>
					<div class="col-md-12" ng-if="metrics[23]">
						<div style="background-color: #eee;padding: 5px;border-radius: 5px;">
							Please think about foods or crops that are unique to your state or region. In the last market season ({{year}}), did you plan to sell any crops or value-added food items that are unique to your egion? If so, please list, and include variety name:<!--ask about regions-->
						</div>
						<textarea ng-model="survey.unique_crops" style="margin-top: 15px;"></textarea>
					</div>
				</div>
				<div class="col-md-6" ng-if="metrics[21]">
					<label>Is more than 50% of your farmers market business owned and operated on a daily basis by one or more women?</label>
					<div class="col-md-12 radioGroup">
						<label class="radio" ng-click="setRad('owned_by_women','yes')" ng-class="{active : survey.owned_by_women == 'yes'}">Yes</label>
						<label class="radio" ng-click="setRad('owned_by_women','no')" ng-class="{active : survey.owned_by_women == 'no'}">No</label>
						<label class="radio" ng-click="setRad('owned_by_women','not_applicable')" ng-class="{active : survey.owned_by_women == 'not_applicable'}">Prefer not to Respond</label>
					</div>
				</div>
				<div class="col-md-6" ng-if="metrics[22]">
					<label>Which of the following best describes the primary operator(s) of your farmers market business? (Please check all that apply):</label>
					<table>
						<tr>
							<td>White (not Spanish, Hispanic, or Latino)</td>
							<td><input type="checkbox" ng-model="survey.operators_white" /></td>
						</tr>
						<tr>
							<td>Spanish, Hispanic, or Latino</td>
							<td><input type="checkbox" ng-model="survey.operators_mexican" /></td>
						</tr>
						<tr>
							<td>Black or African American</td>
							<td><input type="checkbox" ng-model="survey.operators_black" /></td>
						</tr>
						<tr>
							<td>American Indian or Alaska Native</td>
							<td><input type="checkbox" ng-model="survey.operators_indian" /></td>
						</tr>
						<tr>
							<td>Asian or Asian American</td>
							<td><input type="checkbox" ng-model="survey.operators_asian" /></td>
						</tr>
						<tr>
							<td>Other (Please describe):</td>
							<td><input type="checkbox" ng-model="survey.operators_other" /></td>
						</tr>
						<tr>
							<td colspan="2" ng-show="survey.operators_other"><input type="text" ng-model="survey.primary_operators_other" /></td>
						</tr>
					</table>
				</div>
			</div>
			<div ng-show="tab == 3">
				<div class="col-md-6">
					<div class="row" ng-if="metrics[25]">
						<label>In the most recent market season (2014), how many different products did you sell under the certifications checked to the left?</label>
						<input ng-model="survey.num_certified" />
					</div>
					<div class="row" ng-if="metrics[28]">
						<label>How many primary business owners and chief operators of your farmers market business are younger than 35 years of age (as of the most recently completed calendar year)?</label>
						<input ng-model="survey.under_35" />
					</div>
				</div>
				<div class="col-md-6" ng-if="metrics[24]">
					<label>Please select from any certifications your business presently holds (please include certification number if applicable):</label>
					<table>
						<tr>
							<td>Certified Organic</td>
							<td><input type="checkbox" ng-model="survey.certified_organic" /></td>
						</tr>
						<tr>
							<td>Certified Natural</td>
							<td><input type="checkbox" ng-model="survey.certified_natural" /></td>
						</tr>
						<tr>
							<td>Certified Biodynamic</td>
							<td><input type="checkbox" ng-model="survey.certified_biodynamic" /></td>
						</tr>
						<tr>
							<td>Food Alliance Certified</td>
							<td><input type="checkbox" ng-model="survey.certified_food_alliance" /></td>
						</tr>
						<tr>
							<td>Other Certification (Please Name)</td>
							<td><input type="checkbox" ng-model="survey.certified_other" /></td>
						</tr>
						<tr>
							<td colspan="2" ng-show="survey.certified_other"><input type="text" ng-model="survey.certified_other_name" /></td>
						</tr>
						<tr>
							<td>No Certifications:</td>
							<td><input type="checkbox" ng-model="survey.certified_none" /></td>
						</tr>
					</table>
					<!-- ask how to do 34 as well-->
				</div>
			</div>
			<div ng-show="tab == 4">
				<div class="col-md-12">
					<iframe
						id="map"
					    width="100%"
					    height="400"
					    frameborder="0" style="border:0"
					    src="https://www.google.com/maps/embed/v1/place?key=AIzaSyCrNAIWXwdlONA1Z3r6UHgpzBv5BYq_sEs&q=Wisconsin+State+Capitol">
					  </iframe>	
				</div>
				<div class="col-md-12">
					<div class="col-md-6">
						<div class="row">
							<div class="col-md-12 radioGroup">
								<label class="radio" ng-click="setRad('origin',survey.primary_loc)" ng-class="{active : origin == survey.primary_loc}"><span class="loc">Primary Location</span></label>
								<label class="radio" ng-click="setRad('origin',survey.secondary_loc)" ng-class="{active : origin == survey.secondary_loc}"><span class="loc">Secondary Location</span></label>
							</div>
						</div>
						<div class="row">
							<label>Source</label>
							<input ng-model="origin" style="  float: right;" disabled />		
						</div>
						<div class="row">
							<label>Destination</label>
							<input ng-model="dest" style="  float: right;"/>
						</div>
						<div class="row">
							<a href="javascript:void(0)" class="btn btn-primary" ng-click="query()">Find</a>
						</div>
					</div>
					<div class="col-md-6">


					</div>
				</div>
				<div class="col-md-12">
					<div class="col-md-offset-2 col-md-4">
						<a class="btn btn-default" href="javascript:void" ng-click="submitSurvey()">Submit</a>
					</div>
					<div class="col-md-4">
						<a class="btn btn-danger" href="javascript:void" ng-click="reset()">Reset</a>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div id="successScreen"> 
		<a href="#" class="suc-text">Success!</a>
	</div> 
	<div id="cover" ></div>

	<script type="text/javascript">

		function visitorCtrl($scope){

	$scope.changeTab = function(tab){
		$scope.tab = tab;
		$('.progress-bar-success').width((tab == 1 ? 26 : tab*25) + '%');

		window.location.href = '#summary';
	};

	$scope.tab = 1;

	$scope.metrics = <%= raw(@metrics.to_json) %>;
	$scope.profile = <%= raw(@profile.to_json) %>;
	$scope.survey = <%= raw(@application.to_json) %>;

	if($scope.survey == null)
		$scope.survey = {};
	
	var d = new Date();
	$scope.year = d.getFullYear() - 1;

	$scope.setRad = function(model, val){
		if(model == 'origin'){
			$scope.origin = val;
			return;
		}
		$scope.survey[model] = val;
		console.log($scope.survey);
	}

	$scope.query = function(){
		if($scope.origin == '' || $scope.dest == '')
			return

		var origin = $scope.origin.replace(' ', '+');
		var dest = $scope.dest.replace(' ', '+');

		$('#map')[0].src = 'https://www.google.com/maps/embed/v1/directions?origin='+origin+'&destination='+dest+'&key=AIzaSyCrNAIWXwdlONA1Z3r6UHgpzBv5BYq_sEs';
	}

	$scope.submitSurvey = function(){
		
		console.log($scope.survey);

		$.ajax({
			type: "POST",
			url: "/post_visitor_application",
			data: JSON.stringify($scope.survey),
			contentType: "application/json",
			success: function(data){
				console.log(data);
				location.href = '#successScreen';
				setTimeout(ret, 1000);
			},
			error: function(data){
				alert("Error Submitting Data");
			}
		});
	};

	$scope.reset = function(){
		$scope.survey = {};
		$scope.food = {};
	}

	function ret(){
		location.href = "#";
	}
}

</script>
